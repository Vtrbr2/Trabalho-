<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Poppins',sans-serif;background:#f5f7ff;padding:28px}
    .top{display:flex;justify-content:space-between;align-items:center;max-width:1100px;margin:0 auto}
    h2{color:#222}
    .logout{background:#ef4444;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .content{max-width:1100px;margin:18px auto}
    .avaliacao{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:12px;position:relative}
    .btn-excluir{position:absolute;right:12px;top:12px;background:#ff4d4d;color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>
  <div class="top">
    <h2>Painel Admin — Avaliações</h2>
    <div>
      <button id="logoutBtn" class="logout">Sair</button>
    </div>
  </div>

  <div class="content">
    <div id="listaAvaliacoes">Carregando avaliações...</div>
  </div>

  <!-- scripts: bcrypt não necessário aqui -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    // ====== CONFIG SUPABASE (para possíveis chamadas admin) ======
    const SUPABASE_URL = 'https://gkkadwbselqwieaqpxzi.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdra2Fkd2JzZWxxd2llYXFweHppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NjM2NTgsImV4cCI6MjA3ODUzOTY1OH0.sxvEHjDZ8SWiIqzHpUGwqqUUfVqzsAiartvyF2WBaZU';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== CONFIG FIREBASE (o mesmo que você usa) ======
    const firebaseConfig = {
      apiKey: "AIzaSyBF_-yFhm5X3Dy-jd84dHyU4UT5Uta-XhE",
      authDomain: "avaliacoes-20599.firebaseapp.com",
      databaseURL: "https://avaliacoes-20599-default-rtdb.firebaseio.com/",
      projectId: "avaliacoes-20599",
      storageBucket: "avaliacoes-20599.appspot.com",
      messagingSenderId: "1003621715829",
      appId: "1:1003621715829:web:eb82bed77a69e570324d3c"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ===== PROTEÇÃO SIMPLES: checa sessão no localStorage =====
    const sessionRaw = localStorage.getItem('jkAdminSession');
    if (!sessionRaw) {
      location.href = '/admin/login.html';
      throw new Error('Sem sessão');
    }
    try {
      const session = JSON.parse(sessionRaw);
      if (!session.token || Date.now() > session.expires) {
        localStorage.removeItem('jkAdminSession');
        location.href = '/admin/login.html';
        throw new Error('Sessão expirada');
      }
      // ok -> continuar
    } catch (e) {
      localStorage.removeItem('jkAdminSession');
      location.href = '/admin/login.html';
      throw e;
    }

    // ===== carregar avaliações do Firebase =====
    const lista = document.getElementById('listaAvaliacoes');
    const avalRef = ref(db, 'avaliacoes');
    onValue(avalRef, (snap) => {
      lista.innerHTML = '';
      snap.forEach(child => {
        const id = child.key;
        const d = child.val();
        const div = document.createElement('div');
        div.className = 'avaliacao';
        div.innerHTML = `
          <strong>${d.nome || 'Anônimo'}</strong>
          <div style="margin-top:6px">${'★'.repeat(d.estrelas || 0)}</div>
          <p style="margin:6px 0 0">${d.comentario || d.mensagem || ''}</p>
        `;
        const btn = document.createElement('button');
        btn.className = 'btn-excluir';
        btn.textContent = 'Excluir';
        btn.onclick = async () => {
          if (!confirm('Excluir esta avaliação?')) return;
          try {
            await remove(ref(db, 'avaliacoes/' + id));
          } catch (err) {
            alert('Erro ao excluir. Veja console.');
            console.error(err);
          }
        };
        div.appendChild(btn);
        lista.appendChild(div);
      });
    });

    // logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('jkAdminSession');
      location.href = '/admin/login.html';
    });
  </script>
</body>
</html>
